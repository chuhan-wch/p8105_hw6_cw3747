---
title: "p8105_hw6_cw3747"
author: "chuhan wang_cw3747"
date: "2025-11-25"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(patchwork)
library(scales)
library(dplyr)


knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1

### data import

```{r}
homicide = read.csv("./homicide-data.csv") |>
  janitor::clean_names()
```

### city state

```{r}
homicide_clean =
  homicide |> 
  mutate(
    city_state = str_c(city, ", ", state),
    solved = if_else(disposition == "Closed by arrest", "yes", "no"),
    solved = factor(solved, levels = c("no", "yes")),
    victim_age = if_else(victim_age == "Unknown",
                         NA_real_, as.numeric(victim_age))
  ) |>
  filter(
    !city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", 
                       "Tulsa, AL"),
    victim_race %in% c("White", "Black")
  )
```


### baltimore and regression

```{r}
library(broom)

baltimore =
  homicide_clean |>
  filter(city_state == "Baltimore, MD")

fit_baltimore =                 ## the output of glm
  glm(
    solved ~ victim_age + victim_sex + victim_race,
    data = baltimore,
    family = binomial
  )

tidy_baltimore =
  tidy(
    fit_baltimore,
    exponentiate = TRUE,
    conf.int    = TRUE
  )

tidy_baltimore
```

### ORs and CIs for each city

```{r}
or_city =
  homicide_clean |>
  group_by(city_state) |>
  nest() |>
  mutate(
    fit = map(
      data,
      ~ glm(
          solved ~ victim_age + victim_sex + victim_race,
          data   = .x,
          family = binomial
        )
    ),
    tidy_res = map(
      fit,
      ~ tidy(.x, exponentiate = TRUE, conf.int = TRUE)
    )
  ) |>
  select(city_state, tidy_res) |>
  unnest(tidy_res) |>
  filter(term == "victim_sexMale") |>
  select(
    city_state,
    or_male_vs_female = estimate,
    CI_low  = conf.low,
    CI_high = conf.high,
    p_value = p.value
  ) |> 
  ungroup()

or_city
```

### plots

```{r, fig.width = 8, fig.height = 12}
library(ggplot2)
library(forcats)

or_city |>
  mutate(
    city_state = fct_reorder(city_state, or_male_vs_female)
  ) |> 
  ggplot(aes(x = or_male_vs_female, y = city_state)) +
  geom_point() +
  geom_errorbar(aes(xmin = CI_low, xmax = CI_high), width = 0) +
  geom_vline(xintercept = 1, linetype = 2) +
  labs(
    x = "Adjusted OR (male vs female)",
    y = "City",
    title = "Adjusted OR for solved homicides ~ gender"
  )
```

Interpretation:

The plot displays the adjusted odds ratio for a homicide being solved when the victim is male compared with female, controlling for victim age and race for each city.

In most cities the point estimate is below 1, suggesting that cases with male victims generally have lower odds of being solved than cases with female victims, after adjustment for the other covariates.

In several cities near the bottom of the plot (e.g., New York, Baton Rouge, Omaha), the 95% confidence intervals lie entirely below 1, indicating a statistically significant disadvantage for male victims. For many cities in the middle of the figure, the confidence intervals include 1, so we cannot rule out no difference between male and female victims. A few cities at the top have odds ratios above 1, but their intervals are wide, reflecting substantial uncertainty. Overall, the plot suggests both a tendency toward lower clearance for male victims and considerable variation across cities.


## Problem 2

### data import

```{r}
library(p8105.datasets)
data("weather_df")

janitor::clean_names(weather_df)
```


```{r}
weather_clean =
  weather_df |>
  select(tmax, tmin, prcp) |>
  drop_na()
```

```{r}
library(modelr)
library(broom)

set.seed(1)

boot_results = 
  weather_clean |>
  modelr::bootstrap(n = 5000) |>
  mutate(
    model = map(
      strap,
      ~ lm(tmax ~ tmin + prcp, data = .x)
    ),
    model_sum = map(model, glance),
    coef_tbl = map(model, tidy)
  ) |>
  mutate(
    r2 = map_dbl(model_sum, "r.squared"),
    beta_ratio = map_dbl(coef_tbl, ~ {
      b1 = .x |>
        filter(term == "tmin") |>
        pull(estimate)
      b2 = .x %>% 
        filter(term == "prcp") |>
        pull(estimate) 
      b1 / b2
    })
  ) |>
  select(.id, r2, beta_ratio)
```


### plots

```{r}
boot_results |>
  ggplot(aes(x = r2)) +
  geom_histogram(bins = 30)

boot_results |>
  ggplot(aes(x = beta_ratio)) +
  geom_histogram(bins = 30)
```

Interpretation:

For $R^2$, the bootstrap distribution is approximately symmetric and bell--shaped, with a single prominent mode around $0.94$. The resampled $R^2$ values are highly concentrated, mostly lying between about $0.93$ and $0.95$, indicating that the fitted multiple linear regression model consistently explains a large proportion 
of the variability in $tmax$.

For the ratio $\hat\beta_1 / \hat\beta_2$, the bootstrap distribution is unimodal but clearly right--skewed on the negative scale, with a peak near $-200$ and a longer tail extending toward more negative values (approximately down to about $-400$). This suggests greater variability and asymmetry in the sampling  distribution of the ratio of the two slope coefficients compared with $R^2$. 


### CI

```{r}
boot_ci <- boot_results |>
  summarise(
    r2_low   = quantile(r2, 0.025),
    r2_high  = quantile(r2, 0.975),
    br_low   = quantile(beta_ratio, 0.025),
    br_high  = quantile(beta_ratio, 0.975)
  )

boot_ci
```

The 95\% bootstrap confidence interval for $R^2$ is $\left[\,`r round(boot_ci$r2_low, 3)`,\ `r round(boot_ci$r2_high, 3)`\right]$.

The 95\% bootstrap confidence interval for $\hat\beta_1 / \hat\beta_2$ is $\left[\,`r round(boot_ci$br_low, 2)`,\ `r round(boot_ci$br_high, 2)`\right]$.


## Problem3

### data import

```{r}
bw = read.csv("./birthweight.csv") |>
  janitor::clean_names()
```

```{r}
bw |> 
  dplyr::glimpse()
  summary(bw)
  colSums(is.na(bw))
```

```{r}
bw =
  bw |>
  dplyr::mutate(
    babysex = factor(babysex, levels = c(1, 2),
                     labels = c("male", "female")),
    frace  = factor(frace,  levels = c(1,2,3,4,8,9),
                    labels = c("white","black","asian",
                               "puerto_rican","other","unknown")),
    mrace  = factor(mrace,  levels = c(1,2,3,4,8),
                    labels = c("white","black","asian",
                               "puerto_rican","other")),
    malform = factor(malform, levels = c(0,1),
                     labels = c("absent","present"))
  )
```

### MLR

```{r}
mlr_bw =
  lm(
    bwt ~ gaweeks + ppbmi + wtgain + smoken + babysex + mrace + parity + 
      pnumlbw + pnumsga, 
    data = bw
  )

mlr_bw

summary(mlr_bw)
```

\[
\widehat{\text{bwt}} =
553.6 + 54.4\,\text{gaweeks} + 20.1\,\text{ppbmi} + 9.8\,\text{wtgain} - 11.5\,\text{smoken} - 85.7\,\mathbb{I}(\text{babysex}=\text{female}) - 297.5\,\mathbb{I}(\text{mrace}=\text{black}) - 126.6\,\mathbb{I}(\text{mrace}=\text{asian}) - 186.3\,\mathbb{I}(\text{mrace}=\text{puerto\_rican}) + 102.5\,\text{parity}
\]

We fitted a multiple linear regression model with birthweight in grams as the outcome and gestational age, maternal pre-pregnancy BMI, maternal weight gain during pregnancy, daily number of cigarettes smoked, infant sex, maternal race, and parity as predictors.

After adjustment for all other variables in the model, birthweight is positively associated with gestational age, maternal BMI, weight gain, and parity, and negatively associated with cigarette smoking. Infants born to mothers who are Black or Puerto Rican tend to have lower birthweights compared with those born to White mothers, and female infants tend to weigh less than male infants. Overall, the model captures biologically plausible relationships between fetal growth and maternal characteristics, smoking behavior, and sociodemographic factors.

### plots

```{r}
bw_resid =
  bw |>
  modelr::add_predictions(mlr_bw) |>
  modelr::add_residuals(mlr_bw)

bw_resid |>
  ggplot(aes(x = pred, y = resid)) + 
  geom_point(alpha = 0.3) + 
  geom_hline(yintercept = 0, 
             linetype = "dashed") +
  geom_smooth(se = FALSE) +
  labs(
    x = "Fitted values", 
    y = "Residuals",
    title = "Residuals vs fitted values for birthweight model"
  )
```

Process

I used multiple linear regression with birthweight in grams as the outcome. After cleaning the data and turning sex and race into factor variables, I chose predictors that are biologically related to fetal growth: gestational age, maternal pre-pregnancy BMI, weight gain during pregnancy, number of cigarettes smoked per day, infant sex, maternal race, and parity. I first fit a full model including these variables plus indicators for previous low-birthweight and SGA infants. Because the previous low-birthweight/SGA variables were perfectly collinear with the others, R dropped them due to singularities, and the remaining predictors form the final model used for all diagnostics.

Interpretation

In the residuals versus fitted values plot, the points are roughly centered around zero across the range of fitted birthweights, and the spread of residuals is fairly constant, so the mean-zero and constant-variance assumptions look reasonable. The smooth curve stays close to zero in the middle but bends slightly downward at the very low and very high fitted values, suggesting some mild lack of fit at the extremes; overall, the linear model describes the bulk of the data reasonably well.


