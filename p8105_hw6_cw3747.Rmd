---
title: "p8105_hw6_cw3747"
author: "chuhan wang_cw3747"
date: "2025-11-25"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(patchwork)
library(scales)
library(dplyr)


knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1

### data import

```{r}
homicide = read.csv("./homicide-data.csv") |>
  janitor::clean_names()
```

### city state

```{r}
homicide_clean =
  homicide |> 
  mutate(
    city_state = str_c(city, ", ", state),
    solved = if_else(disposition == "Closed by arrest", "yes", "no"),
    solved = factor(solved, levels = c("no", "yes")),
    victim_age = if_else(victim_age == "Unknown",
                         NA_real_, as.numeric(victim_age))
  ) |>
  filter(
    !city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", 
                       "Tulsa, AL"),
    victim_race %in% c("White", "Black")
  )
```


### baltimore and regression

```{r}
library(broom)

baltimore =
  homicide_clean |>
  filter(city_state == "Baltimore, MD")

fit_baltimore =                 ## the output of glm
  glm(
    solved ~ victim_age + victim_sex + victim_race,
    data = baltimore,
    family = binomial
  )

tidy_baltimore =
  tidy(
    fit_baltimore,
    exponentiate = TRUE,
    conf.int    = TRUE
  )

tidy_baltimore
```

### ORs and CIs for each city

```{r}
or_city =
  homicide_clean |>
  group_by(city_state) |>
  nest() |>
  mutate(
    fit = map(
      data,
      ~ glm(
          solved ~ victim_age + victim_sex + victim_race,
          data   = .x,
          family = binomial
        )
    ),
    tidy_res = map(
      fit,
      ~ tidy(.x, exponentiate = TRUE, conf.int = TRUE)
    )
  ) |>
  select(city_state, tidy_res) |>
  unnest(tidy_res) |>
  filter(term == "victim_sexMale") |>
  select(
    city_state,
    or_male_vs_female = estimate,
    CI_low  = conf.low,
    CI_high = conf.high,
    p_value = p.value
  ) |> 
  ungroup()

or_city
```

### plots

```{r, fig.width = 8, fig.height = 12}
library(ggplot2)
library(forcats)

or_city |>
  mutate(
    city_state = fct_reorder(city_state, or_male_vs_female)
  ) |> 
  ggplot(aes(x = or_male_vs_female, y = city_state)) +
  geom_point() +
  geom_errorbar(aes(xmin = CI_low, xmax = CI_high), width = 0) +
  geom_vline(xintercept = 1, linetype = 2) +
  labs(
    x = "Adjusted OR (male vs female)",
    y = "City",
    title = "Adjusted OR for solved homicides ~ gender"
  )
```

Interpretation:

The plot displays the adjusted odds ratio for a homicide being solved when the victim is male compared with female, controlling for victim age and race for each city.

In most cities the point estimate is below 1, suggesting that cases with male victims generally have lower odds of being solved than cases with female victims, after adjustment for the other covariates.

In several cities near the bottom of the plot (e.g., New York, Baton Rouge, Omaha), the 95% confidence intervals lie entirely below 1, indicating a statistically significant disadvantage for male victims. For many cities in the middle of the figure, the confidence intervals include 1, so we cannot rule out no difference between male and female victims. A few cities at the top have odds ratios above 1, but their intervals are wide, reflecting substantial uncertainty. Overall, the plot suggests both a tendency toward lower clearance for male victims and considerable variation across cities.