p8105_hw6_cw3747
================
chuhan wang_cw3747
2025-11-25

``` r
library(tidyverse)
```

    ## ── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
    ## ✔ dplyr     1.1.4     ✔ readr     2.1.5
    ## ✔ forcats   1.0.0     ✔ stringr   1.5.1
    ## ✔ ggplot2   3.5.2     ✔ tibble    3.3.0
    ## ✔ lubridate 1.9.4     ✔ tidyr     1.3.1
    ## ✔ purrr     1.1.0     
    ## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
    ## ✖ dplyr::filter() masks stats::filter()
    ## ✖ dplyr::lag()    masks stats::lag()
    ## ℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors

``` r
library(patchwork)
library(scales)
```

    ## 
    ## Attaching package: 'scales'
    ## 
    ## The following object is masked from 'package:purrr':
    ## 
    ##     discard
    ## 
    ## The following object is masked from 'package:readr':
    ## 
    ##     col_factor

``` r
library(dplyr)


knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1

### data import

``` r
homicide = read.csv("./homicide-data.csv") |>
  janitor::clean_names()
```

### city state

``` r
homicide_clean =
  homicide |> 
  mutate(
    city_state = str_c(city, ", ", state),
    solved = if_else(disposition == "Closed by arrest", "yes", "no"),
    solved = factor(solved, levels = c("no", "yes")),
    victim_age = if_else(victim_age == "Unknown",
                         NA_real_, as.numeric(victim_age))
  ) |>
  filter(
    !city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", 
                       "Tulsa, AL"),
    victim_race %in% c("White", "Black")
  )
```

    ## Warning: There was 1 warning in `mutate()`.
    ## ℹ In argument: `victim_age = if_else(victim_age == "Unknown", NA_real_,
    ##   as.numeric(victim_age))`.
    ## Caused by warning in `if_else()`:
    ## ! NAs introduced by coercion

### baltimore and regression

``` r
library(broom)

baltimore =
  homicide_clean |>
  filter(city_state == "Baltimore, MD")

fit_baltimore =                 ## the output of glm
  glm(
    solved ~ victim_age + victim_sex + victim_race,
    data = baltimore,
    family = binomial
  )

tidy_baltimore =
  tidy(
    fit_baltimore,
    exponentiate = TRUE,
    conf.int    = TRUE
  )

tidy_baltimore
```

    ## # A tibble: 4 × 7
    ##   term             estimate std.error statistic  p.value conf.low conf.high
    ##   <chr>               <dbl>     <dbl>     <dbl>    <dbl>    <dbl>     <dbl>
    ## 1 (Intercept)         1.36    0.171        1.81 7.04e- 2    0.976     1.91 
    ## 2 victim_age          0.993   0.00332     -2.02 4.30e- 2    0.987     1.000
    ## 3 victim_sexMale      0.426   0.138       -6.18 6.26e-10    0.324     0.558
    ## 4 victim_raceWhite    2.32    0.175        4.82 1.45e- 6    1.65      3.28

### ORs and CIs for each city

``` r
or_city =
  homicide_clean |>
  group_by(city_state) |>
  nest() |>
  mutate(
    fit = map(
      data,
      ~ glm(
          solved ~ victim_age + victim_sex + victim_race,
          data   = .x,
          family = binomial
        )
    ),
    tidy_res = map(
      fit,
      ~ tidy(.x, exponentiate = TRUE, conf.int = TRUE)
    )
  ) |>
  select(city_state, tidy_res) |>
  unnest(tidy_res) |>
  filter(term == "victim_sexMale") |>
  select(
    city_state,
    or_male_vs_female = estimate,
    CI_low  = conf.low,
    CI_high = conf.high,
    p_value = p.value
  ) |> 
  ungroup()
```

    ## Warning: There were 43 warnings in `mutate()`.
    ## The first warning was:
    ## ℹ In argument: `tidy_res = map(fit, ~tidy(.x, exponentiate = TRUE, conf.int =
    ##   TRUE))`.
    ## ℹ In group 1: `city_state = "Albuquerque, NM"`.
    ## Caused by warning:
    ## ! glm.fit: fitted probabilities numerically 0 or 1 occurred
    ## ℹ Run `dplyr::last_dplyr_warnings()` to see the 42 remaining warnings.

``` r
or_city
```

    ## # A tibble: 47 × 5
    ##    city_state      or_male_vs_female CI_low CI_high   p_value
    ##    <chr>                       <dbl>  <dbl>   <dbl>     <dbl>
    ##  1 Albuquerque, NM             1.77   0.825   3.76  1.39 e- 1
    ##  2 Atlanta, GA                 1.00   0.680   1.46  1.000e+ 0
    ##  3 Baltimore, MD               0.426  0.324   0.558 6.26 e-10
    ##  4 Baton Rouge, LA             0.381  0.204   0.684 1.65 e- 3
    ##  5 Birmingham, AL              0.870  0.571   1.31  5.11 e- 1
    ##  6 Boston, MA                  0.674  0.353   1.28  2.26 e- 1
    ##  7 Buffalo, NY                 0.521  0.288   0.936 2.90 e- 2
    ##  8 Charlotte, NC               0.884  0.551   1.39  6.00 e- 1
    ##  9 Chicago, IL                 0.410  0.336   0.501 1.86 e-18
    ## 10 Cincinnati, OH              0.400  0.231   0.667 6.49 e- 4
    ## # ℹ 37 more rows

### plots

``` r
library(ggplot2)
library(forcats)

or_city |>
  mutate(
    city_state = fct_reorder(city_state, or_male_vs_female)
  ) |> 
  ggplot(aes(x = or_male_vs_female, y = city_state)) +
  geom_point() +
  geom_errorbar(aes(xmin = CI_low, xmax = CI_high), width = 0) +
  geom_vline(xintercept = 1, linetype = 2) +
  labs(
    x = "Adjusted OR (male vs female)",
    y = "City",
    title = "Adjusted OR for solved homicides ~ gender"
  )
```

<img src="p8105_hw6_cw3747_files/figure-gfm/unnamed-chunk-6-1.png" width="90%" />

Interpretation:

The plot displays the adjusted odds ratio for a homicide being solved
when the victim is male compared with female, controlling for victim age
and race for each city.

In most cities the point estimate is below 1, suggesting that cases with
male victims generally have lower odds of being solved than cases with
female victims, after adjustment for the other covariates.

In several cities near the bottom of the plot (e.g., New York, Baton
Rouge, Omaha), the 95% confidence intervals lie entirely below 1,
indicating a statistically significant disadvantage for male victims.
For many cities in the middle of the figure, the confidence intervals
include 1, so we cannot rule out no difference between male and female
victims. A few cities at the top have odds ratios above 1, but their
intervals are wide, reflecting substantial uncertainty. Overall, the
plot suggests both a tendency toward lower clearance for male victims
and considerable variation across cities.

## Problem 2

### data import

``` r
library(p8105.datasets)
data("weather_df")

janitor::clean_names(weather_df)
```

    ## # A tibble: 2,190 × 6
    ##    name           id          date        prcp  tmax  tmin
    ##    <chr>          <chr>       <date>     <dbl> <dbl> <dbl>
    ##  1 CentralPark_NY USW00094728 2021-01-01   157   4.4   0.6
    ##  2 CentralPark_NY USW00094728 2021-01-02    13  10.6   2.2
    ##  3 CentralPark_NY USW00094728 2021-01-03    56   3.3   1.1
    ##  4 CentralPark_NY USW00094728 2021-01-04     5   6.1   1.7
    ##  5 CentralPark_NY USW00094728 2021-01-05     0   5.6   2.2
    ##  6 CentralPark_NY USW00094728 2021-01-06     0   5     1.1
    ##  7 CentralPark_NY USW00094728 2021-01-07     0   5    -1  
    ##  8 CentralPark_NY USW00094728 2021-01-08     0   2.8  -2.7
    ##  9 CentralPark_NY USW00094728 2021-01-09     0   2.8  -4.3
    ## 10 CentralPark_NY USW00094728 2021-01-10     0   5    -1.6
    ## # ℹ 2,180 more rows

``` r
weather_clean =
  weather_df |>
  select(tmax, tmin, prcp) |>
  drop_na()
```

``` r
library(modelr)
```

    ## 
    ## Attaching package: 'modelr'

    ## The following object is masked from 'package:broom':
    ## 
    ##     bootstrap

``` r
library(broom)

set.seed(1)

boot_results = 
  weather_clean |>
  modelr::bootstrap(n = 5000) |>
  mutate(
    model = map(
      strap,
      ~ lm(tmax ~ tmin + prcp, data = .x)
    ),
    model_sum = map(model, glance),
    coef_tbl = map(model, tidy)
  ) |>
  mutate(
    r2 = map_dbl(model_sum, "r.squared"),
    beta_ratio = map_dbl(coef_tbl, ~ {
      b1 = .x |>
        filter(term == "tmin") |>
        pull(estimate)
      b2 = .x %>% 
        filter(term == "prcp") |>
        pull(estimate) 
      b1 / b2
    })
  ) |>
  select(.id, r2, beta_ratio)
```
